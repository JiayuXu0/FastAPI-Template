# 敏感词过滤功能文档

## 概述

本系统集成了基于AhoCorasick算法的敏感词过滤功能，可以在用户输入和AI响应中检测并过滤敏感内容。当检测到敏感词时，系统会返回预设的提醒信息："这个问题我不太清楚，请换个话题。"

## 功能特性

- **高效检测**: 使用AhoCorasick算法，支持多模式字符串匹配，性能优异
- **实时过滤**: 支持流式和非流式输出的实时敏感词检测
- **动态管理**: 提供API接口动态管理敏感词列表
- **灵活配置**: 支持启用/禁用过滤功能
- **详细日志**: 记录敏感词检测和过滤的详细日志

## 配置说明

### 配置文件 (`src/settings/config.py`)

```python
# 敏感词过滤配置
SENSITIVE_WORDS: typing.List[str] = [
    "敏感词1",
    "敏感词2",
    "政治敏感内容",
    "违法内容",
    "暴力内容",
    # 可以根据需要添加更多敏感词
]
SENSITIVE_WORD_RESPONSE: str = "这个问题我不太清楚，请换个话题。"
ENABLE_SENSITIVE_WORD_FILTER: bool = True
```

### 配置参数说明

- `SENSITIVE_WORDS`: 敏感词列表，支持中英文
- `SENSITIVE_WORD_RESPONSE`: 检测到敏感词时返回的提醒信息
- `ENABLE_SENSITIVE_WORD_FILTER`: 是否启用敏感词过滤功能

## 依赖安装

系统使用 `pyahocorasick` 库实现敏感词检测：

```bash
pip install pyahocorasick
```

该依赖已添加到 `requirements.txt` 文件中。

## API接口

### 1. 获取敏感词列表

```http
GET /api/v1/sensitive-words/list
```

**权限要求**: 超级管理员

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "words": ["敏感词1", "敏感词2"],
    "enabled": true,
    "response_message": "这个问题我不太清楚，请换个话题。",
    "total": 2
  },
  "message": "success"
}
```

### 2. 添加敏感词

```http
POST /api/v1/sensitive-words/add
```

**权限要求**: 超级管理员

**请求体**:
```json
{
  "words": ["新敏感词1", "新敏感词2"]
}
```

### 3. 删除敏感词

```http
POST /api/v1/sensitive-words/remove
```

**权限要求**: 超级管理员

**请求体**:
```json
{
  "words": ["要删除的敏感词1", "要删除的敏感词2"]
}
```

### 4. 测试敏感词检测

```http
POST /api/v1/sensitive-words/test
```

**权限要求**: 超级管理员

**请求体**:
```json
{
  "text": "这是一段包含敏感词的测试文本"
}
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "original_text": "这是一段包含敏感词的测试文本",
    "contains_sensitive": true,
    "matched_word": "敏感词",
    "filtered_text": "这个问题我不太清楚，请换个话题。",
    "is_blocked": true
  },
  "message": "success"
}
```

### 5. 启用/禁用敏感词过滤

```http
POST /api/v1/sensitive-words/toggle
```

**权限要求**: 超级管理员

### 6. 获取过滤器状态

```http
GET /api/v1/sensitive-words/status
```

**权限要求**: 已认证用户

## 工作原理

### 1. 初始化阶段

系统启动时，`SensitiveWordFilter` 类会：
- 读取配置文件中的敏感词列表
- 构建AhoCorasick自动机
- 准备进行高效的多模式匹配

### 2. 用户输入检测

在 `/api/v1/agent/{agent_id}/chat` 接口中：
- 首先检测用户输入的查询内容
- 如果包含敏感词，直接返回提醒信息
- 支持流式和非流式两种响应模式

### 3. AI响应过滤

#### 流式输出过滤
- 对每个输出数据块进行实时检测
- 检测到敏感词时立即停止输出
- 发送敏感词提醒事件给客户端

#### 非流式输出过滤
- 对完整的AI响应进行检测
- 检测到敏感词时更新消息状态为"blocked"
- 将AI响应替换为提醒信息

## 日志记录

系统会记录以下敏感词相关的日志：

- 敏感词过滤器初始化状态
- 用户输入中检测到的敏感词
- AI响应中检测到的敏感词
- 敏感词列表的动态更新操作
- 过滤器状态的变更

## 性能考虑

- **AhoCorasick算法**: 时间复杂度为O(n+m+z)，其中n是文本长度，m是模式总长度，z是匹配数量
- **内存使用**: 自动机构建后常驻内存，查询速度快
- **并发安全**: 支持多线程并发访问

## 安全特性

- **权限控制**: 只有超级管理员可以管理敏感词列表
- **日志审计**: 所有敏感词相关操作都有详细日志记录
- **实时生效**: 敏感词列表更新后立即生效
- **容错处理**: 过滤器异常时不影响正常业务流程

## 扩展建议

1. **敏感词分类**: 可以为不同类型的敏感词设置不同的处理策略
2. **白名单机制**: 为特定用户或场景设置敏感词白名单
3. **敏感度等级**: 设置不同等级的敏感词，采用不同的处理方式
4. **统计分析**: 记录敏感词触发统计，用于内容安全分析
5. **外部词库**: 支持从外部API或文件导入敏感词库

## 故障排除

### 常见问题

1. **敏感词不生效**
   - 检查 `ENABLE_SENSITIVE_WORD_FILTER` 配置
   - 查看日志确认自动机是否构建成功
   - 确认敏感词列表不为空

2. **性能问题**
   - 检查敏感词列表大小
   - 监控内存使用情况
   - 考虑优化敏感词列表

3. **误判问题**
   - 检查敏感词是否过于宽泛
   - 考虑添加上下文判断逻辑
   - 使用测试接口验证检测结果

### 调试方法

1. 使用测试接口验证敏感词检测
2. 查看详细日志了解过滤过程
3. 检查配置文件确认参数正确
4. 验证权限设置是否正确